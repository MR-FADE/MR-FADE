<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ - MR FADE</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #121212;
      color: #f5f5f5;
      font-family: 'Poppins', 'Vazirmatn', sans-serif;
      padding: 15px;
      min-height: 100vh;
    }
    .container {
      max-width: 560px;
      margin: 30px auto;
      background: #1e1e1e;
      border-radius: 32px;
      padding: 35px;
      box-shadow: 0 15px 50px rgba(0,0,0,0.4);
      border: 1px solid #2a2a2a;
    }
    .logo {
      width: 220px;
      max-width: 75%;
      margin: 0 auto 25px;
      display: block;
      filter: drop-shadow(0 0 12px rgba(212, 175, 55, 0.3));
    }
    .counter {
      text-align: center;
      padding: 20px;
      border-radius: 22px;
      margin: 20px 0;
      font-weight: 600;
      font-size: 1.2rem;
      background: rgba(30, 30, 30, 0.7);
      color: #f5f5f5;
      border: 1px solid #2a2a2a;
      box-shadow: inset 0 0 15px rgba(0,0,0,0.5), 0 4px 15px rgba(0,0,0,0.2);
      backdrop-filter: blur(6px);
      line-height: 1.6;
    }
    .barber-status {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 1.1rem;
    }
    .barber-status span {
      background: rgba(46, 125, 50, 0.2);
      padding: 6px 12px;
      border-radius: 12px;
      font-weight: 600;
    }
    .full { background: rgba(198, 40, 40, 0.2) !important; color: #ffcdd2; }

    input, select {
      width: 100%;
      padding: 18px;
      margin: 13px 0;
      border: 1px solid #2a2a2a;
      border-radius: 20px;
      font-size: 1.2rem;
      outline: none;
      background: #252525;
      color: #f5f5f5;
      transition: all 0.35s;
      font-family: 'Poppins', sans-serif;
    }
    input:focus, select:focus {
      border-color: #d4af37;
      box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3);
      background: #2a2a2a;
    }
    button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #6c1e1e, #8b2525);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 1.35rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s ease;
      font-family: 'Poppins', sans-serif;
      letter-spacing: 0.8px;
      box-shadow: 0 6px 20px rgba(108, 30, 30, 0.4);
      position: relative;
    }
    button:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    button:hover:not(:disabled) {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(108, 30, 30, 0.6), 0 0 20px rgba(212, 175, 55, 0.2);
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    #message {
      text-align: center;
      margin-top: 26px;
      padding: 16px;
      border-radius: 18px;
      display: none;
      font-weight: 600;
      font-size: 1.15rem;
      backdrop-filter: blur(6px);
      border: 1px solid;
    }
    .error { 
      background: rgba(198, 40, 40, 0.15);
      color: #ffcdd2;
      border-color: #c62828;
    }
    .success { 
      background: rgba(46, 125, 50, 0.15);
      color: #c8e6c9;
      border-color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://i.ibb.co/NgpMdYNB/logo-1.png" alt="MR FADE Logo" class="logo">
    <div id="serviceTitle">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    
    <div class="counter" id="counter">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <input type="text" id="name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="name" />
    <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" autocomplete="tel" />
    
    <select id="barber">
      <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø­Ù„Ø§Ù‚</option>
      <option value="Ø§Ù„Ø³Ø¹ÙŠØ¯">ÙƒØ±Ø³ÙŠ 1 â€” Ø§Ù„Ø³Ø¹ÙŠØ¯</option>
      <option value="Ø£Ø­Ù…Ø¯">ÙƒØ±Ø³ÙŠ 2 â€” Ø£Ø­Ù…Ø¯</option>
    </select>

    <button id="bookBtn" disabled>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
    <div id="message"></div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxNGrrtCj2Ayx2q8HYL_QpYpAUUdbWlwcHA1G3Pf6-3gVJaKiWu0MGA5ysyoRYHtIagHw/exec";
    const selectedService = localStorage.getItem('selectedService') || "";
    if (!selectedService) window.location.href = 'index.html';
    document.getElementById('serviceTitle').textContent = selectedService;

    const limits = { Ø§Ù„Ø³Ø¹ÙŠØ¯: 20, Ø£Ø­Ù…Ø¯: 10 };
    let counts = { Ø§Ù„Ø³Ø¹ÙŠØ¯: 0, Ø£Ø­Ù…Ø¯: 0 };
    let isBooking = false;

    // --- Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù…Ù† Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª) ---
    function updateCounterUI() {
      const counterEl = document.getElementById('counter');
      const bookBtn = document.getElementById('bookBtn');
      const barber = document.getElementById('barber').value;

      if (new Date().getHours() < 13) {
        counterEl.innerHTML = "Ø§Ù„Ø­Ø¬Ø² ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© <strong>1:00 Ø¸Ù‡Ø±Ù‹Ø§</strong>";
        counterEl.style.background = 'rgba(212,175,55,0.1)';
        counterEl.style.color = '#d4af37';
        bookBtn.disabled = true;
        bookBtn.textContent = "ØºÙŠØ± Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†";
        return;
      }

      const remainingSa3id = limits.Ø§Ù„Ø³Ø¹ÙŠØ¯ - counts.Ø§Ù„Ø³Ø¹ÙŠØ¯;
      const remainingAhmed = limits.Ø£Ø­Ù…Ø¯ - counts.Ø£Ø­Ù…Ø¯;

      counterEl.innerHTML = `
        <div>Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</div>
        <div class="barber-status">
          <span ${remainingSa3id <= 0 ? 'class="full"' : ''}>Ø§Ù„Ø³Ø¹ÙŠØ¯: ${Math.max(0, remainingSa3id)}</span>
          <span ${remainingAhmed <= 0 ? 'class="full"' : ''}>Ø£Ø­Ù…Ø¯: ${Math.max(0, remainingAhmed)}</span>
        </div>
      `;

      if (!isBooking && barber === "Ø§Ù„Ø³Ø¹ÙŠØ¯" && remainingSa3id > 0) {
        bookBtn.disabled = false;
        bookBtn.textContent = "Ø§Ø­Ø¬Ø² Ù…Ø¹ Ø§Ù„Ø³Ø¹ÙŠØ¯";
      } else if (!isBooking && barber === "Ø£Ø­Ù…Ø¯" && remainingAhmed > 0) {
        bookBtn.disabled = false;
        bookBtn.textContent = "Ø§Ø­Ø¬Ø² Ù…Ø¹ Ø£Ø­Ù…Ø¯";
      } else {
        bookBtn.disabled = true;
        bookBtn.textContent = "ØºÙŠØ± Ù…ØªØ§Ø­";
      }
    }

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚) ---
    async function loadCounts() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getBarberCounts`);
        const data = await res.json();
        counts.Ø§Ù„Ø³Ø¹ÙŠØ¯ = data.sa3id || 0;
        counts.Ø£Ø­Ù…Ø¯ = data.ahmed || 0;
        updateCounterUI();
      } catch (e) {
        const el = document.getElementById('counter');
        el.textContent = "ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯";
        el.style.background = 'rgba(198,40,40,0.15)';
        el.style.color = '#ffcdd2';
      }
    }

    // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² (Ù…Ø¹ ØªØ£Ø®ÙŠØ± 3 Ø«ÙˆØ§Ù†Ù ÙˆØ­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ØªØ²Ø§Ù…Ù†) ---
    async function submitBooking() {
      if (new Date().getHours() < 13) {
        showMessage("Ø§Ù„Ø­Ø¬Ø² ØºÙŠØ± Ù…ØªØ§Ø­ Ø­ØªÙ‰ Ø§Ù„Ø³Ø§Ø¹Ø© 1 Ø¸Ù‡Ø±Ù‹Ø§ â°", false);
        return;
      }

      const bookBtn = document.getElementById('bookBtn');
      if (bookBtn.disabled) return; // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const barber = document.getElementById('barber').value;

      if (!name || !phone || !barber) {
        showMessage("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", false);
        return;
      }

      // âœ… ØªØ¹Ø·ÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù…Ø¯Ø© 3 Ø«ÙˆØ§Ù†Ù
      isBooking = true;
      bookBtn.disabled = true;
      bookBtn.innerHTML = '<span class="spinner"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...';

      try {
        const params = new URLSearchParams({ action: "book", name, phone, service: selectedService, barber });
        const res = await fetch(`${WEB_APP_URL}?${params.toString()}`);
        const result = await res.text();

        if (result === "OK") {
          showMessage(`ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ù…Ø¹ ${barber} Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰`, true);
          document.getElementById('name').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('barber').selectedIndex = 0;
          loadCounts(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±
        } else if (result === "full") {
          showMessage(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø§ÙƒÙ† Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ø¹ ${barber}`, false);
          loadCounts();
        } else if (result === "early") {
          showMessage("Ø§Ù„Ø­Ø¬Ø² Ù…ØªØ§Ø­ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 1 Ø¸Ù‡Ø±Ù‹Ø§ ÙÙ‚Ø·", false);
        } else {
          showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§", false);
        }
      } catch (e) {
        showMessage("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„", false);
      } finally {
        setTimeout(() => {
          isBooking = false;
          updateCounterUI();
        }, 3000); // â±ï¸ 3 Ø«ÙˆØ§Ù†Ù Ø¨Ø§Ù„Ø¶Ø¨Ø·
      }
    }

    function showMessage(msg, isSuccess) {
      const el = document.getElementById('message');
      el.textContent = msg;
      el.className = isSuccess ? 'success' : 'error';
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 4000);
    }

    // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---
    document.getElementById('barber').onchange = updateCounterUI;
    document.getElementById('bookBtn').onclick = submitBooking;

    // --- ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ---
    loadCounts();
    updateCounterUI();
    setInterval(() => updateCounterUI(), 3000);
  </script>
</body>
</html>
